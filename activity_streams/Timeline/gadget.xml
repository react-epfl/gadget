<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="Timeline"
                author_email="aubry.cholleton@epfl.ch"
                author="Aubry Cholleton"
                description="Displays a timeline of the context activity during the last week.">
    <Require feature="opensocial-0.9"/>
    <Require feature="osapi"/>
    <Require feature="dynamic-height"/>
</ModulePrefs>
<Content type="html"><![CDATA[
<style> 
body {
  background-color: transparent;
  color:#666;
  margin-top:10px
} 
</style>

<script class="include" language="javascript" type="text/javascript" src="../../libs/jquery-1.8.0.min.js"></script>
<script class="include" language="javascript" type="text/javascript" src="../../libs/moment/moment.min.js"></script>
<script type="text/javascript">
moment().format();



function createTimeline(response) {
  var date = new Date;
  activities = response.entry;
  actions = ["add", "update", "join", "remove", "delete"];
  actions_past = {"add" : "added", "update" : "updated", "join" : "joined", "delete" : "deleted"};
  for(var i = 0; i < activities.length ; i++) {
    if ($.inArray(activities[i].verb, actions) != -1) {
      $('#timeline').append("<div id='item"+i+"'>");
      date = new Date(activities[i].published);
      $('#timeline').append(moment(date).fromNow() + ", ");
      $('#timeline').append(formatItemName(activities[i].object, activities[i].target, activities[i].actor, activities[i].verb, actions_past));
      $('#timeline').append("</div>");
    }
  }
  gadgets.window.adjustHeight();
}

function formatItemName(object, target, actor, verb, actions) {
  var thisSpace = "this space";
  var hasBeen = " has been ";
  var has = " has ";
  var to = " to ";
  var from = " from ";


  // Check whether the current context is the 
  // target or the object of the activity.
  var objectId = -1;
  if (object.id != undefined) {
    objectId=object.id.split('/').pop();
  } else {
    object.id = "Deleted object";
  }
  var targetId = -1;
  if (target != undefined) {
    targetId=target.id.split('/').pop();
  }

  var name = "unknown object"
  var isObject = false;
  if (objectId == gcontextId) {
    isObject = true;
  } else if (targetId == gcontextId) {
    isObject = false;
  } else {
    return "This activity is unrelated to this space.";
  }

  var sentence = ""
  switch(verb)
  {
  case "add":
    if(isObject) {
      sentence += thisSpace.charAt(0).toUpperCase()+thisSpace.slice(1)+hasBeen+actions["add"]+to+target.displayName;
    } else {
      sentence += object.id+hasBeen+actions["add"]+to+thisSpace;
    }
    break;
  case "update":
    if(isObject) {
      sentence += thisSpace.charAt(0).toUpperCase()+thisSpace.slice(1)+hasBeen+actions["update"];
    }
    break;
  case "join":
    if(isObject) {
      sentence += actor.displayName+has+actions["join"]+" "+thisSpace;
    }
    break;
  case "delete":
    if(!isObject) {
      sentence += object.id+hasBeen+actions["delete"]+from+thisSpace;
    }
    break;
  default:
    sentence += "Unexpected activity.";
  }

  sentence += " by "+actor.displayName+".";
  return sentence;
}


function loadActivities(){
  var today = new Date();
  var lastWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate()-7);
  osapi.activitystreams.get({contextId: window.gcontextId, contextType: window.gcontextType, updatedSince:lastWeek.toISOString(), sortOrder: "descending"}).execute(function(response){
    createTimeline(response);
  });
}

function findContext(){
  osapi.context.get().execute(function(context){
    gcontextId = context.contextId;
    gcontextType = context.contextType;
    loadActivities();
  });
}


gadgets.util.registerOnLoadHandler(findContext);

</script>
<h1>Timeline</h1>
<div id="timeline"></div>
]]></Content>
</Module>